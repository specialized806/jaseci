import streamlit as st;
import requests;

def bootstrap_frontend(token: str) {
    st.set_page_config(
        page_title="Friendzone Lite - Memory Assistant", page_icon="ğŸ§ ", layout="wide"
    );

    st.title("ğŸ§  Friendzone Lite - Memory Assistant");
    st.markdown("âœ¨ Capture and organize your memories from images");

    # Initialize session state
    if "memory_results" not in st.session_state {
        st.session_state.memory_results = None;
    }
    if "conversation_active" not in st.session_state {
        st.session_state.conversation_active = False;
    }
    if "image_url" not in st.session_state {
        st.session_state.image_url = "";
    }
    if "conversation_history" not in st.session_state {
        st.session_state.conversation_history = [];
    }
    if "loading" not in st.session_state {
        st.session_state.loading = False;
    }

    # Main interface
    st.markdown("### ğŸ“· Start Your Memory Journey");

    # Image URL input section
    if not st.session_state.conversation_active {
        st.markdown("#### ğŸŒ Enter Image URL");
        image_url = st.text_input(
            "ğŸ”— Image URL:",
            placeholder="https://example.com/your-image.jpg",
            help="Enter the URL of an image containing a memory you'd like to capture"
        );
        if st.button("ğŸš€ Start Memory Session") {
            if image_url.strip() {
                st.session_state.image_url = image_url;
                st.session_state.conversation_active = True;
                st.session_state.loading = True;
                st.rerun();
            } else {
                st.warning("âš ï¸ Please enter a valid image URL!");
            }
        }
    }

    # Active conversation section
    if st.session_state.conversation_active {
        # Display current image
        st.markdown("#### ğŸ“· Current Image");
        try {
            st.image(
                st.session_state.image_url,
                caption="Memory Image",
                use_column_width=True
            );
        } except Exception {
            st.warning("âš ï¸ Could not display image. Proceeding with URL...");
        }
        # Initialize session if loading
        if st.session_state.loading and not st.session_state.memory_results {
            with st.spinner("ğŸ§  AI is analyzing your image...") {
                try {
                    response = requests.post(
                        "http://localhost:8000/walker/update_session",
                        json={"image_url": st.session_state.image_url, "utterance": ""},
                        headers={"Authorization": f"Bearer {token}"}
                    );

                    if response.status_code == 200 {
                        result = response.json();
                        st.session_state.memory_results = result.get("reports", [{}])[
                            0
                        ];
                        st.session_state.loading = False;
                        st.success("âœ… Memory session started!");
                        st.rerun();
                    } else {
                        st.error(f"âŒ Failed to start session: {response.text}");
                        st.session_state.loading = False;
                    }
                } except Exception as e {
                    st.error(f"âŒ Error: {str(e)}");
                    st.session_state.loading = False;
                }
            }
        }
        # Display memory progress
        if st.session_state.memory_results {
            results = st.session_state.memory_results;
            # Memory summary section
            st.markdown("#### ğŸ“ Memory Details");
            st.markdown("**ğŸ“… When:**");
            when_val = results.get("when", "Not specified");
            if when_val {
                st.info(when_val);
            } else {
                st.info("Not specified");
            }
            st.markdown("**ğŸ‘¥ Who:**");
            who_val = results.get("who", []);
            if who_val {
                st.info(", ".join(who_val));
            } else {
                st.info("Not specified");
            }
            st.markdown("**ğŸ“ Where:**");
            where_val = results.get("where", []);
            if where_val {
                st.info(", ".join(where_val));
            } else {
                st.info("Not specified");
            }
            st.markdown("**ğŸ¯ What:**");
            what_val = results.get("what", "");
            if what_val {
                st.info(what_val);
            } else {
                st.info("Not specified");
            }
            # Summary
            if results.get("summary") {
                st.markdown("**ğŸ“‹ Memory Summary:**");
                if results.get("show_summary", False) {
                    if results.get("terminate_conversation", False) {
                        st.success(f"âœ… Final Memory Summary: {results['summary']}");
                    } else {
                        st.info(
                            f"ğŸ“ Memory Summary (in progress): {results['summary']}"
                        );
                    }
                } else {
                    st.write("ğŸ“ Building memory summary...");
                }
            }
            # Conversation section
            st.markdown("#### ğŸ’¬ Conversation");
            # Display conversation history
            if st.session_state.conversation_history {
                for msg in st.session_state.conversation_history {
                    if msg["role"] == "user" {
                        st.chat_message("user").write(f"ğŸ‘¤ {msg['content']}");
                    } else {
                        st.chat_message("assistant").write(f"ğŸ¤– {msg['content']}");
                    }
                }
            }
            # Check if conversation is complete
            if results.get("show_summary", False)
            and results.get("terminate_conversation", False) {
                st.success("ğŸ‰ Memory capture complete!");
                if st.button("ğŸ”„ Start New Memory Session") {
                    st.session_state.conversation_active = False;
                    st.session_state.memory_results = None;
                    st.session_state.image_url = "";
                    st.session_state.conversation_history = [];
                    st.session_state.loading = False;
                    st.rerun();
                }
            } else {
                # User input for continuing conversation
                user_input = st.chat_input("Continue the conversation...");
                if user_input {
                    # Add user message to history
                    st.session_state.conversation_history.append(
                        {"role": "user", "content": user_input}
                    );
                    # Send to backend
                    with st.spinner("ğŸ¤– AI is processing your response...") {
                        try {
                            response = requests.post(
                                "http://localhost:8000/walker/update_session",
                                json={
                                    "image_url": st.session_state.image_url,
                                    "utterance": user_input
                                },
                                headers={"Authorization": f"Bearer {token}"}
                            );

                            if response.status_code == 200 {
                                result = response.json();
                                st.session_state.memory_results = result.get(
                                    "reports", [{}]
                                )[0];
                                # Add assistant response to history
                                if "follow_up_questions" in st.session_state.memory_results {
                                    st.session_state.conversation_history.append(
                                        {
                                            "role": "assistant",
                                            "content": st.session_state.memory_results[
                                                "follow_up_questions"
                                            ]
                                        }
                                    );
                                }
                                st.rerun();
                            } else {
                                st.error(
                                    f"âŒ Failed to process response: {response.text}"
                                );
                            }
                        } except Exception as e {
                            st.error(f"âŒ Error: {str(e)}");
                        }
                    }
                }
            }
        }
        # Reset session button
        if st.button("ğŸ”„ Reset Session") {
            st.session_state.conversation_active = False;
            st.session_state.memory_results = None;
            st.session_state.image_url = "";
            st.session_state.conversation_history = [];
            st.session_state.loading = False;
            st.rerun();
        }
    }

    # Footer
    st.markdown("---");
    st.markdown("**ğŸ§  Powered by Friendzone Lite AI Assistant**");
    st.markdown(
        "âœ¨ Features: ğŸ“· Image analysis â€¢ ğŸ’­ Memory extraction â€¢ ğŸ“ Structured capture"
    );
}

with entry {
    INSTANCE_URL = "http://localhost:8000";
    TEST_USER_EMAIL = "test@mail.com";
    TEST_USER_PASSWORD = "password";

    response = requests.post(
        f"{INSTANCE_URL}/user/login",
        json={"email": TEST_USER_EMAIL, "password": TEST_USER_PASSWORD}
    );

    if response.status_code != 200 {
        # Try registering the user if login fails
        response = requests.post(
            f"{INSTANCE_URL}/user/register",
            json={"email": TEST_USER_EMAIL, "password": TEST_USER_PASSWORD}
        );
        assert response.status_code == 201;
        response = requests.post(
            f"{INSTANCE_URL}/user/login",
            json={"email": TEST_USER_EMAIL, "password": TEST_USER_PASSWORD}
        );
        assert response.status_code == 200;
    }

    token = response.json()["token"];

    bootstrap_frontend(token);
}
